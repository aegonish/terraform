import jenkins.model.*
import com.cloudbees.plugins.credentials.*
import com.cloudbees.plugins.credentials.domains.*
import com.cloudbees.plugins.credentials.impl.*
import org.jenkinsci.plugins.plaincredentials.impl.*
import hudson.util.Secret
import com.cloudbees.plugins.credentials.CredentialsScope

def store = Jenkins.instance.getExtensionList('com.cloudbees.plugins.credentials.SystemCredentialsProvider')[0].getStore()

println "âœ… Running Jenkins init.groovy.d â†’ credentials setup..."

// âœ… GitHub as Username + Password
def githubId = 'github-pat'
if (!store.getCredentials(Domain.global()).any { it.id == githubId }) {
    def githubCred = new UsernamePasswordCredentialsImpl(
        CredentialsScope.GLOBAL,
        githubId,
        'GitHub Personal Access Token',
        '{{ vault_github_username }}',
        '{{ vault_github_pat }}'
    )
    store.addCredentials(Domain.global(), githubCred)
    println "âœ… Added GitHub PAT (username/password)"
}

// âœ… DockerHub (already correct)
def dockerId = 'dockerhub-credentials'
if (!store.getCredentials(Domain.global()).any { it.id == dockerId }) {
    def dockerCred = new UsernamePasswordCredentialsImpl(
        CredentialsScope.GLOBAL,
        dockerId,
        'DockerHub Credentials',
        '{{ vault_dockerhub_username }}',
        '{{ vault_dockerhub_password }}'
    )
    store.addCredentials(Domain.global(), dockerCred)
    println "âœ… Added DockerHub credentials"
}

// âœ… AWS (correct CloudBees AWS credential type)
def awsId = 'aws-creds'
if (!store.getCredentials(Domain.global()).any { it.id == awsId }) {
    def awsCred = new com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl(
        CredentialsScope.GLOBAL,
        awsId,
        'AWS Credentials (Access Key / Secret Key)',
        '{{ vault_aws_access_key }}',
        '{{ vault_aws_secret_key }}'
    )
    store.addCredentials(Domain.global(), awsCred)
    println "âœ… Added AWS credentials"
}


// .env (Secret Text)
def envId = 'aegonish-env'
if (!store.getCredentials(Domain.global()).any { it.id == envId }) {
    def envCred = new StringCredentialsImpl(
        CredentialsScope.GLOBAL,
        envId,
        '.env File Contents',
        Secret.fromString('''{{ vault_env_file | trim }}''')
    )
    store.addCredentials(Domain.global(), envCred)
    println "âœ… Added .env secret text"
}


println "ðŸŽ‰ ALL credentials corrected & ready!"
