---
# ==========================================================
# Role: jenkins_credentials
# Purpose: Auto-create Jenkins credentials via init script
# ==========================================================

- name: Ensure Jenkins init.groovy.d directory exists
  file:
    path: /var/lib/jenkins/init.groovy.d
    state: directory
    owner: jenkins
    group: jenkins
    mode: '0755'
  become: yes

- name: Template Jenkins credentials init script
  template:
    src: init_create_credentials.groovy.j2
    dest: /var/lib/jenkins/init.groovy.d/init_create_credentials.groovy
    owner: jenkins
    group: jenkins
    mode: '0644'
  become: yes

# âœ… FORCE JENKINS TO RUN init.groovy.d SCRIPTS AGAIN
- name: Remove Jenkins setup completion files
  become: yes
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/lib/jenkins/jenkins.install.UpgradeWizard.state
    - /var/lib/jenkins/jenkins.install.InstallUtil.lastExecVersion
  register: removed_wizard

- name: Restart Jenkins so init script executes
  become: yes
  systemd:
    name: jenkins
    state: restarted
    daemon_reload: yes

# âœ… Ensure Jenkins is fully online before we check anything
- name: Wait for Jenkins login page to be available
  uri:
    url: http://localhost:8080/login
    status_code: 200
  register: jenkins_up
  retries: 20
  delay: 6
  until: jenkins_up.status == 200

# âœ… Debug output for faster troubleshooting
- debug:
    msg:
      - "ðŸŽ¯ Jenkins Init Script installed: /var/lib/jenkins/init.groovy.d/init_create_credentials.groovy"
      - "ðŸ›‘ Setup wizard reset: {{ removed_wizard.changed }}"
      - "âœ… Jenkins restarted & up. Credentials should now exist!"
