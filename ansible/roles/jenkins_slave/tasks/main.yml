---
# ========================================
# Jenkins Slave: Install & Connect Agent
# ========================================

- name: Install Java, Docker, Git, AWS CLI on slave
  raw: |
    set -eux
    yum install -y java-17-amazon-corretto git docker awscli || \
    dnf install -y java-17-amazon-corretto git docker awscli
    systemctl enable docker
    systemctl start docker
  delegate_to: "{{ jenkins_slave_ip }}"
  become: yes

# âœ… Ensure Docker is running
- name: Enable & start Docker on slave
  become: yes
  ansible.builtin.service:
    name: docker
    state: started
    enabled: yes
  delegate_to: "{{ jenkins_slave_ip }}"

# âœ… FIX: Allow ec2-user to run Docker (needed for Jenkins builds)
- name: Add ec2-user to docker group
  become: yes
  ansible.builtin.user:
    name: ec2-user
    groups: docker
    append: yes
  delegate_to: "{{ jenkins_slave_ip }}"

# âœ… Restart Docker so group membership is applied
- name: Restart Docker after adding ec2-user
  become: yes
  ansible.builtin.service:
    name: docker
    state: restarted
  delegate_to: "{{ jenkins_slave_ip }}"

# âœ… Check that ec2-user can run Docker (debug output)
- name: Test Docker access for ec2-user
  become: yes
  become_user: ec2-user
  ansible.builtin.command: docker ps
  register: docker_access_check
  failed_when: docker_access_check.rc != 0
  delegate_to: "{{ jenkins_slave_ip }}"

- debug:
    msg: "Docker access validated for ec2-user âœ…"

# ========================================
# Jenkins Agent Setup
# ========================================

- name: Create Jenkins agent directory on slave
  become: yes
  ansible.builtin.file:
    path: /opt/jenkins
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: '0755'
  delegate_to: "{{ jenkins_slave_ip }}"

- name: Download agent.jar from master to slave
  become: yes
  ansible.builtin.get_url:
    url: "http://{{ jenkins_master_ip }}:8080/jnlpJars/agent.jar"
    dest: /opt/jenkins/agent.jar
    mode: '0755'
  delegate_to: "{{ jenkins_slave_ip }}"

# âœ… Register node in Jenkins master dynamically
- name: Create Jenkins slave node via Script API
  ansible.builtin.uri:
    url: "http://{{ jenkins_master_ip }}:8080/scriptText"
    method: POST
    user: "{{ jenkins_admin_user }}"
    password: "{{ jenkins_admin_token }}"
    force_basic_auth: yes
    body: "script={{ lookup('template', 'register_slave.groovy.j2') | urlencode }}"
    headers:
      Content-Type: application/x-www-form-urlencoded
  register: slave_create_output
  changed_when: slave_create_output.status == 200
  failed_when: slave_create_output.status not in [200,201]

- debug:
    msg: "{{ slave_create_output.content | default('no response') }}"

# âœ… Auto-connect service (JNLP)
- name: Install Jenkins agent systemd service
  become: yes
  ansible.builtin.template:
    src: jenkins-agent.service.j2
    dest: /etc/systemd/system/jenkins-agent.service
  delegate_to: "{{ jenkins_slave_ip }}"

- name: Start and enable Jenkins agent service
  become: yes
  ansible.builtin.systemd:
    name: jenkins-agent
    state: started
    enabled: yes
    daemon_reload: yes
  delegate_to: "{{ jenkins_slave_ip }}"

- name: ðŸŽ¯ Slave setup completed!
  debug:
    msg: "âœ… Jenkins slave successfully registered & ready for CI builds!"
