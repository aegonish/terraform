---
# ========================================
# Jenkins Slave: Install & Connect Agent
# ========================================

- name: Install Java, Docker, Git, AWS CLI on slave (raw)
  raw: |
    set -eux
    yum install -y java-17-amazon-corretto git docker awscli || \
    dnf install -y java-17-amazon-corretto git docker awscli
    systemctl enable docker
    systemctl start docker
  delegate_to: "{{ jenkins_slave_ip }}"
  become: yes


- name: Enable & start Docker on slave
  become: yes
  ansible.builtin.service:
    name: docker
    state: started
    enabled: yes
  delegate_to: "{{ jenkins_slave_ip }}"

- name: Create Jenkins agent directory on slave
  become: yes
  ansible.builtin.file:
    path: /opt/jenkins
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: '0755'
  delegate_to: "{{ jenkins_slave_ip }}"

- name: Download agent.jar from master to slave
  become: yes
  ansible.builtin.get_url:
    url: "http://{{ jenkins_master_ip }}:8080/jnlpJars/agent.jar"
    dest: /opt/jenkins/agent.jar
    mode: '0755'
  delegate_to: "{{ jenkins_slave_ip }}"

# âœ… Create Jenkins node configuration
- name: Create Jenkins slave node via Script API
  ansible.builtin.uri:
    url: "http://{{ jenkins_master_ip }}:8080/scriptText"
    method: POST
    user: "{{ jenkins_admin_user }}"
    password: "{{ jenkins_admin_token }}"
    force_basic_auth: yes
    body: "script={{ lookup('template', 'register_slave.groovy.j2') | urlencode }}"
    headers:
      Content-Type: application/x-www-form-urlencoded
  register: slave_create_output
  changed_when: slave_create_output.status == 200
  failed_when: slave_create_output.status not in [200,201]

- name: "Debug: Jenkins slave registration result"
  debug:
    msg: "{{ slave_create_output.content | default('no response') }}"

# âœ… Create systemd service for JNLP auto-connect
- name: Install Jenkins agent systemd service
  become: yes
  ansible.builtin.template:
    src: jenkins-agent.service.j2
    dest: /etc/systemd/system/jenkins-agent.service
  delegate_to: "{{ jenkins_slave_ip }}"

- name: Start and enable Jenkins agent service
  become: yes
  ansible.builtin.systemd:
    name: jenkins-agent
    state: started
    enabled: yes
    daemon_reload: yes
  delegate_to: "{{ jenkins_slave_ip }}"

- name: "âœ… Slave setup completed!"
  debug:
    msg: "ðŸŽ¯ Jenkins slave successfully registered & connected!"
