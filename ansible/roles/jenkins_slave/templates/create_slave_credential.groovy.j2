// roles/jenkins_slave/templates/create_slave_credential.groovy.j2
import com.cloudbees.plugins.credentials.*
import com.cloudbees.plugins.credentials.domains.*
import com.cloudbees.plugins.credentials.impl.*
import jenkins.model.Jenkins
import hudson.util.Secret
import com.cloudbees.plugins.credentials.CredentialsScope
import org.jenkinsci.plugins.plaincredentials.impl.*

def jenkins = Jenkins.instance
def store = jenkins.getExtensionList('com.cloudbees.plugins.credentials.SystemCredentialsProvider')[0].getStore()

def existing = com.cloudbees.plugins.credentials.CredentialsProvider.lookupCredentials(
    com.cloudbees.plugins.credentials.common.StandardUsernameCredentials.class,
    jenkins,
    null,
    null
).find { it.id == "slave-ssh-key" }

if (existing) {
    println("Credential 'slave-ssh-key' already exists. Skipping creation.")
} else {
    // The private key is inlined by Ansible into this script.
    String privateKey = """{{ private_key_content | replace('\n','\n') }}"""

    def credential = new BasicSSHUserPrivateKey(
        CredentialsScope.GLOBAL,
        "slave-ssh-key",
        "ec2-user",
        new BasicSSHUserPrivateKey.DirectEntryPrivateKeySource(privateKey),
        "",
        "SSH key for Jenkins slave node"
    )

    store.addCredentials(Domain.global(), credential)
    // Persist
    jenkins.getExtensionList('com.cloudbees.plugins.credentials.SystemCredentialsProvider')[0].save()
    jenkins.save()

    println("âœ… Created SSH credential with ID 'slave-ssh-key' and saved successfully!")
}
