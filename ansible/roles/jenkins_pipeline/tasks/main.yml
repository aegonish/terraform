---
- name: Wait for Jenkins to be ready before creating the pipeline job
  uri:
    url: http://localhost:8080/login
    status_code: 200
  register: jenkins_ready
  retries: 10
  delay: 10
  until: jenkins_ready.status == 200
  tags: [jenkins_pipeline]

- name: Create Jenkins pipeline job Groovy script from template
  template:
    src: create_pipeline_job.groovy.j2
    dest: /tmp/create_pipeline_job.groovy
  become: yes
  tags: [jenkins_pipeline]

- name: Read Groovy script content from remote node
  slurp:
    src: /tmp/create_pipeline_job.groovy
  register: pipeline_script
  become: yes
  tags: [jenkins_pipeline]

- name: Push pipeline creation Groovy script to Jenkins
  uri:
    url: "http://localhost:8080/scriptText"
    method: POST
    user: "{{ jenkins_admin_user }}"
    password: "{{ jenkins_admin_token }}"
    force_basic_auth: yes
    body: "script={{ (pipeline_script.content | default('') ) | b64decode | urlencode }}"
    headers:
      Content-Type: application/x-www-form-urlencoded
  register: groovy_output
  # fail when HTTP status not in 200..201 or response contains Exception
  failed_when: >
    (groovy_output.status is defined and groovy_output.status not in [200,201])
    or ("Exception" in (groovy_output.content | default('')) )
  changed_when: groovy_output.status is defined and groovy_output.status in [200,201]
  tags: [jenkins_pipeline]

- name: Print Jenkins pipeline creation result
  debug:
    msg: >
      âœ… Jenkins pipeline creation finished.
      Status: {{ groovy_output.status | default('n/a') }}
      Response: {{ (groovy_output.content | default(''))[:400] | default('no content') }}
  tags: [jenkins_pipeline]
