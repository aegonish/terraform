---
- hosts: jenkins_master
  become: yes
  gather_facts: no  # ✅ Prevent Python 3.7 failure on startup

  pre_tasks:
    - name: ✅ Install Python 3.8 and set as default
      shell: |
        sudo yum install -y python38 python3-pip
        sudo alternatives --set python /usr/bin/python3.8
        sudo ln -sf /usr/bin/python3.8 /usr/bin/python3
      args:
        executable: /bin/bash
      tags: always

    - name: ✅ Wait for Python to be ready before enabling facts
      raw: "echo 'Python OK'"
      changed_when: false
      tags: always

    - name: ✅ Tell Ansible to use Python 3.8 going forward
      set_fact:
        ansible_python_interpreter: /usr/bin/python3.8
      tags: always

    - name: ✅ Enable fact gathering now that Python 3.8 is active
      setup:
      tags: always

  roles:
    - role: jenkins_master
      tags: jenkins_master

    - role: jenkins_credentials
      tags: jenkins_credentials

    - role: jenkins_pipeline
      tags: jenkins_pipeline

    - role: jenkins_slave
      tags: jenkins_slave
